<html>
    <script src='https://assets.onfido.com/web-sdk-releases/3.0.1/onfido.min.js'></script>
    <link rel='stylesheet' href='https://assets.onfido.com/web-sdk-releases/3.0.1/style.css'>
    <style>
        html, body {
          height: 100%;
          margin: 0;
        }

        body, button {
          -webkit-font-smoothing: antialiased;
        }

        @media (min-width: 30em) {
          #onfido-mount {
            position: relative;
            top: 10%;
          }

          .onfido-sdk-ui-Modal-inner {
            font-family: "Open Sans", sans-serif !important;
          }
        }
    </style>

    <body>

    <!-- At the bottom of your page, you need an empty element where the
    verification component will be mounted. -->
    <div id='onfido-mount'></div>

    </body>


    <script>


    // Get the token from the jwtToken.txt file in the pkg/kyc directory
    // Relies on python -m SimpleHTTPServer to serve out of the same dir for development
    var tokenReq = new XMLHttpRequest();

    tokenReq.open('GET', "http://localhost:8000/jwtToken.txt", true);
    tokenReq.send();
    tokenReq.onload = function() {

      if (tokenReq.status >= 200 && tokenReq.status < 400) { 
        console.log("civil token = " + tokenReq.responseText);
        civilToken = tokenReq.responseText;
      } else {
        throw 'No jwtToken.txt file found, need to add that file with your token to the local dir';
      }

      // Get the applicant ID from the query params
      var theUrl = new URL(window.location.href);
      var applicantID = theUrl.searchParams.get("applicantID");
      console.log("applicantID = " + applicantID);

      // Get the serverURL from the query params
      var serverURL = theUrl.searchParams.get("serverURL");
      if (serverURL == null) {
          serverURL = "http://localhost:8080/v1/query";
      }
      console.log("serverURL = " + serverURL);

      // Call to retrieve the SDK token
      var tokenRequest = {
          "query":"mutation { kycGenerateSdkToken(applicantID: \"" + applicantID + "\")}"
      }

      var request = new XMLHttpRequest();
      request.open('POST', serverURL, true);
      request.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
      request.setRequestHeader("Authorization", "Bearer " + civilToken);
      request.send(JSON.stringify(tokenRequest));

      request.onload = function() {
        if (request.status >= 200 && request.status < 400) {
          var data = JSON.parse(request.responseText);
          var token = data.data.kycGenerateSdkToken;
          console.log("onfido token = " + token);

          // Initialize the Onfido Web SDK with the Onfido Token
          Onfido.init({
            useModal: false,
            token: token,
            onComplete: function(data) {
              // Callback to the Civil API to create a new check on Onfido
              console.log(
                  "everything is complete, calling to start check, data.face.variant = " + data.face.variant
              );
              var crequest = new XMLHttpRequest();
              var checkRequest = {
                  "query":"mutation { kycCreateCheck(applicantID: \"" + applicantID + "\", facialVariant: \"" + data.face.variant +"\")}"
              }
              crequest.open('POST', serverURL, true);
              crequest.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
              crequest.setRequestHeader("Authorization", "Bearer " + civilToken);
              crequest.send(JSON.stringify(checkRequest));
              crequest.onload = function() {
                  if (request.status >= 200 && request.status < 400) {
                      var cdata = JSON.parse(crequest.responseText);
                      console.log(cdata);
                      console.log(request.status + ", new check id = " + cdata.data.kycCreateCheck);
                  }
              }
              crequest.send()
            },
            steps: [
              'welcome',
              'document',
              'face',
              'complete'
            ]
          });
        }
      }
    }
    </script>
</html>
